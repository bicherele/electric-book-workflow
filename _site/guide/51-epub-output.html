


<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <title>: Epub output</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="/electric-book-workflow/css/web.css" />
    <link rel="stylesheet" type="text/css" media="print" href="../css/print.css" />
    <link rel="stylesheet" type="text/css" media="print" href="../css/mods/print-no-bleed.css" />
</head>
<body class="chapter">





		<div id="nav-bar" class="non-printing">
			<p>
				<a href="/electric-book-workflow/" title="Home: Electric Book Workflow" class="nav-series">Electric Book Workflow</a>
				<a href="0-3-contents.html" title="A Guide to the Electric Book Workflow" class="nav-book">A Guide to the Electric Book Workflow</a>
				<a href="" title="Top: Epub output"  class="nav-page">Epub output</a>
			</p>
		</div><!--#nav-bar-->

	<div id="wrapper">

<h1 class="no_toc" id="epub-output">Epub output</h1>

<ul id="markdown-toc">
  <li><a href="#assembling-the-epub" id="markdown-toc-assembling-the-epub">Assembling the epub</a>    <ul>
      <li><a href="#quicker-epub-output" id="markdown-toc-quicker-epub-output">Quicker epub output</a>        <ul>
          <li><a href="#quick-epub-process-checklist" id="markdown-toc-quick-epub-process-checklist">Quick-epub process checklist</a></li>
        </ul>
      </li>
      <li><a href="#splitting-large-files" id="markdown-toc-splitting-large-files">Splitting large files</a></li>
    </ul>
  </li>
  <li><a href="#mobi-conversion" id="markdown-toc-mobi-conversion">Mobi conversion</a></li>
  <li><a href="#adding-ibooks-display-options-file" id="markdown-toc-adding-ibooks-display-options-file">Adding iBooks display-options file</a></li>
</ul>

<h2 id="assembling-the-epub">Assembling the epub</h2>

<p>We like to assemble our epubs (as EPUB2 for compatibility with older ereaders) in <a href="https://github.com/user-none/Sigil/">Sigil</a>. If we’re not changing something major, it takes five minutes. (See the pro tip below for an even quicker way.)</p>

<ol>
  <li>Put the HTML files from <code class="highlighter-rouge">_site</code> into your <code class="highlighter-rouge">Text</code> folder.</li>
  <li>Put the finished <code class="highlighter-rouge">epub.css</code> (from <code class="highlighter-rouge">_site/css</code>) into your Sigil <code class="highlighter-rouge">Styles</code> folder. (The <code class="highlighter-rouge">epub.css</code> file is a trimmed version of <code class="highlighter-rouge">screen.css</code>. It does not link to font files and avoids CSS3 features, like @fontface, some pseudo classes and media queries, to work better with popular readers with poor or buggy CSS support, such as Adobe Digital Editions.)</li>
  <li>If your book has a child stylesheet, add that, too.</li>
  <li>Replace any SVG images in the <code class="highlighter-rouge">Images</code> folder with JPG equivalents. And:</li>
  <li>Search-and-replace any links to .svg in your HTML files with .jpg.</li>
  <li>Replace the links to <code class="highlighter-rouge">screen.css</code> in your <code class="highlighter-rouge">&lt;head&gt;</code> elements with links to <code class="highlighter-rouge">epub.css</code>.</li>
  <li>Remove the link to the print CSS in your <code class="highlighter-rouge">&lt;head&gt;</code> elements.</li>
  <li>Copy any fonts into the <code class="highlighter-rouge">Fonts</code> folder, if you want them embedded. (If you don’t want to embed fonts, remove any <code class="highlighter-rouge">@font-face</code> rules from your stylesheet to avoid file-not-found validation errors. We don’t recommend embedding fonts unless they are required for meaning or unusual character sets.)</li>
  <li>
    <p>Search-and-replace to remove the <code class="highlighter-rouge">nav-bar</code> div (the link to <code class="highlighter-rouge">/</code> won’t validate in an epub because it’s not reachable). To find the nav-bar div in Sigil, use this DotAll Regex search:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>(?s).&lt;div class="non-printing" id="nav-bar"&gt;(.*)&lt;!--#nav-bar--&gt;
</code></pre>
    </div>

    <p>(You may need to reverse the order of the class and id attributes.)</p>
  </li>
  <li>
    <p>Search-and-replace to remove the <code class="highlighter-rouge">footer</code> div (it’s unnecessary in an ebook, and its links may break anyway). To remove the footer div in Sigil, use this DotAll Regex search and replace with nothing:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>(?s).&lt;div class="non-printing" id="footer"&gt;(.*)&lt;!--#footer--&gt;
</code></pre>
    </div>
  </li>
  <li>
    <p>Remove videos in iframes (iframes are invalid in EPUB2 XHTML 1.1). We recommend replacing videos with a link to an online version, e.g. to a YouTube page. This is best done manually. Search for <code class="highlighter-rouge">videowrapper</code> to find instances of embedded videos. The DotAll regex for finding the video wrapper is:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code>(?s).&lt;div class="videowrapper non-printing"&gt;(.*)&lt;/div&gt;&lt;!--.videowrapper--&gt;
</code></pre>
    </div>
    <p>To <strong>replace</strong> the standard video wrapper with a link to the video:</p>

    <ul>
      <li>
        <p>Search (with DotAll regex) for:</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>(?s).&lt;div class="videowrapper non-printing"&gt;(.*)src="(.*?)"(.*)&lt;/div&gt;(.*?)&lt;!--.videowrapper--&gt;
</code></pre>
        </div>

        <p>This will find the videowrapper and store the URL of the embedded video in memory.</p>
      </li>
      <li>
        <p>Replace with</p>

        <div class="highlighter-rouge"><pre class="highlight"><code>&lt;a href="\2" class="button"&gt;Watch&lt;/a&gt;
</code></pre>
        </div>

        <p>This will replace the entire wrapper with a link to the same iframe URL it memorised (at <code class="highlighter-rouge">\2</code>). Replace <code class="highlighter-rouge">Watch</code> with whatever phrase you want to be the clickable text.</p>
      </li>
    </ul>
  </li>
  <li>If your book includes endnotes (kramdown footnotes), replace <code class="highlighter-rouge">fnref:</code> with <code class="highlighter-rouge">fnref-</code> and <code class="highlighter-rouge">fn:</code> with <code class="highlighter-rouge">fn-</code>. ( Background: If you have a colon in any element ID – for instance if you’ve used <a href="http://kramdown.gettalong.org/quickref.html#footnotes">kramdown’s footnote syntax</a> – EpubCheck will return an ‘invalid NCName’ error. You need to replace those colons with another character. If your invalid IDs follow a set pattern (as kramdown’s footnote references do), you can replace-all quickly.)</li>
  <li>Add basic metadata to your epub using Sigil’s Metadata Editor. Include at least:
    <ul>
      <li>title: subtitle</li>
      <li>author</li>
      <li>date of creation</li>
      <li>publisher</li>
      <li>ISBN (or other identifier like a <a href="https://www.uuidgenerator.net/">UUID</a>)</li>
      <li>Relation ISBN (if any; we use the print ISBN as a parent ISBN)</li>
    </ul>
  </li>
  <li>Add semantics (right click the file name in Sigil for the semantics context menu) to:
    <ul>
      <li>key HTML files</li>
      <li>the cover JPG.</li>
    </ul>
  </li>
  <li id="adding-the-epub-toc">Generate the epub’s table of contents (Tools &gt; Table Of Contents…). This TOC is generated only from the headings (<code class="highlighter-rouge">h1</code> to <code class="highlighter-rouge">h6</code>) in the text. So it does not include the cover, which has no heading, or any other files without a heading (e.g. sometimes the copyright page). If you need to add a cover to the TOC:
    <ol>
      <li>Go to Tools &gt; Table Of Contents &gt; Edit Table Of Contents…</li>
      <li>Click on the first entry in the TOC list.</li>
      <li>Click ‘Add Above’.</li>
      <li>Click ‘Select Target’ and select the cover HTML file (usually <code class="highlighter-rouge">0-0-cover.html</code>).</li>
      <li>In the blank space under ‘TOC Entry’, double-click and type ‘Cover’.</li>
      <li>Click Okay.</li>
      <li>Use the same process for adding any other files you need to add to the TOC.</li>
    </ol>
  </li>
  <li>If fonts are important (you’ve either embedded fonts or the difference between serif and sans-serif is semantically significant), add iBooks XML. (<a href="#adding-ibooks-display-options-file">See below for detail</a>.)</li>
  <li>Check that the cover works, using your own cover-image jpg. For info on improving your epub cover layout, see the <code class="highlighter-rouge">cover.xhtml</code> and cover CSS snippets <a href="http://electricbookworks.com/kb/creating-epub-from-indesign/after-indesign-export-to-epub/add-a-cover/">on our Knowledge Base</a>. (We’ve already added the relevant cover CSS snippets to <code class="highlighter-rouge">epub.css</code>.)</li>
  <li id="validate-the-epub">Validate the epub in Sigil and fix any validation errors. Sigil let’s some things past that EpubCheck flags, so also validate with EpubCheck directly. You can use:
    <ul>
      <li>the <a href="http://validator.idpf.org/">IDPF’s online version of EpubCheck</a></li>
      <li><a href="https://github.com/IDPF/epubcheck/wiki/Running">epubcheck</a> installed locally, and run from the command line; or</li>
      <li><a href="http://www.pagina-online.de/produkte/epub-checker/">pagina EPUB-Checker</a>.</li>
    </ul>
  </li>
</ol>

<p>For general guidance on creating epubs with Sigil, check out <a href="http://electricbookworks.github.io/ebw-training/">EBW’s training material</a> and the <a href="https://github.com/Sigil-Ebook/Sigil/tree/master/docs">Sigil user guide</a>.</p>

<h3 id="quicker-epub-output">Quicker epub output</h3>

<p>Our template includes a Jekyll layout specifically for creating epubs. To use it, change the default <code class="highlighter-rouge">output</code> in <code class="highlighter-rouge">_config.yml</code> (globally or for a given book’s folder path) to <code class="highlighter-rouge">epub</code>. We include both options, and comment one of them out. So just switch which one is commented out:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>output: "epub"
#output: "default"
</code></pre>
</div>

<p>Remember to restart Jekyll after changing <code class="highlighter-rouge">_config.yml</code> for changes to take effect, and change it back to <code class="highlighter-rouge">default</code> afterwards (<code class="highlighter-rouge">default</code> is necessary for print and web output).</p>

<p>The <code class="highlighter-rouge">epub</code> output lets you skip a few of the steps listed above, because it:</p>

<ul>
  <li>links to the epub CSS you specify in <code class="highlighter-rouge">_config.yml</code> (using Sigil’s standard <code class="highlighter-rouge">../Styles/</code> path)</li>
  <li>omits the nav bar and footer (no need to search and replace these)</li>
  <li>includes required epub metadata (if you’ve included it in your <code class="highlighter-rouge">_config.yml</code> file).</li>
</ul>

<p>To get the metadata to import to Sigil, you must <em>open</em> one of your book’s HTML files in Sigil (the cover is best, since it’s the first file). That is, don’t ‘Add Existing Files…’ to a new, blank epub. Only by opening a single HTML file (as in ‘File &gt; Open…’, then select the HTML file) will Sigil read and import the file’s Dublin Core metadata. After that, you can add the remaining files in Sigil using ‘Add Existing Files…’.</p>

<blockquote>
  <p>Pro tip: you can avoid having to change your config file to <code class="highlighter-rouge">output: "epub"</code> by loading a second config file when you build or serve Jekyll at the command line. The second config file sets the <code class="highlighter-rouge">output</code>, overriding the default config. To do this, use:</p>

  <p><code class="highlighter-rouge">jekyll build --config _config.yml,_config.epub.yml</code></p>

  <p>We also provide a second config file for PDF ebook output:</p>

  <p><code class="highlighter-rouge">jekyll build --config _config.yml,_config.pdf-ebook.yml</code></p>
</blockquote>

<h4 id="quick-epub-process-checklist">Quick-epub process checklist</h4>

<p>If you’ve generated HTML using the <code class="highlighter-rouge">output: epub</code> setting in <code class="highlighter-rouge">_config.yml</code>, your basic process in Sigil is as follows.</p>

<ol>
  <li>File &gt; Open… and select the first HTML file in <code class="highlighter-rouge">_site/yourbook</code>.</li>
  <li>Right-click the Text folder &gt; Add Existing Files… and select the remaining HTML files for the epub.</li>
  <li>Right-click the Text or Styles folder &gt; Add Existing Files… and select the epub’s CSS file in <code class="highlighter-rouge">_site/css</code>.</li>
  <li>Tools &gt; Table Of Contents &gt; Generate Table Of Contents</li>
  <li>Add file semantics (right-click HTML files &gt; Add Semantics… and right-click the cover jpg &gt; Cover Image).</li>
  <li>Save, and <a href="#validate-the-epub">validate</a> with the Flightcrew plugin and separately with EPUBCheck.</li>
</ol>

<p>Depending on your needs, you may also need to:</p>

<ul>
  <li>search-and-replace (<a href="#assembling-the-epub">as described above</a>) for SVG images, footnotes, or video;</li>
  <li>add the cover (or other files) to your table of contents (<a href="#adding-the-epub-toc">as described above</a>)</li>
  <li>add font files if you’re embedding fonts;</li>
  <li>split large files (<a href="#splitting-large-files">as described below</a>)</li>
  <li>add the iBooks display-options XML (<a href="#adding-ibooks-display-options-file">as described below</a>).</li>
</ul>

<h3 id="splitting-large-files">Splitting large files</h3>

<p>If you have very large text files that, in the epub output, you’d like to split up into separate HTML files, Sigil can help. Using this tag in HTML, you can mark where Sigil must split your HTML file(s):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;hr class="sigil_split_marker" /&gt;
</code></pre>
</div>

<p>To create that in kramdown:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>***
{:.sigil_split_marker}
</code></pre>
</div>

<p>Also, remember to hide those markers in print output (and web and elsewhere as needed) with this in your CSS:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>.sigil_split_marker {
	display: none;
}
</code></pre>
</div>

<p>Then, when you’re assembling the epub in Sigil, just run Edit &gt; Split At Markers.</p>

<p>Sigil will then split the HTML file into separate HTML files at the markers, and remove the <code class="highlighter-rouge">&lt;hr&gt;</code> element.</p>

<p>A common use case for this is books with end-of-book endnotes. To create end-of-book endnotes using kramdown footnotes you must put all content with endnotes in one markdown (and therefore HTML) file. This file is too large for sensible epub use, so splitting is important. Sigil is smart enough to update your internal links when you run ‘Split At Markers’.</p>

<blockquote>
  <p><strong>NB: Before running Split At Markers: save, close, and reopen your epub.</strong> At least till Sigil 0.9.3, there is <a href="http://www.mobileread.com/forums/showthread.php?p=3277498#post3277498">an issue with updating internal links when using Split At Markers</a>. In order for internal links to update correctly, Sigil must <em>first</em> have rewritten all link paths to HTML files according to its <code class="highlighter-rouge">../Text/</code> folder structure (e.g. the links to chapters in a Table of Contents file). Sigil only rewrites all these paths when an epub file is opened. So to make sure links are udpated when running Split At Markers, you need to save, close, and reopen the epub first. This <a href="http://www.mobileread.com/forums/showpost.php?p=3277552&amp;postcount=11">may be fixed from Sigil 0.9.5</a>.</p>
</blockquote>

<h2 id="mobi-conversion">Mobi conversion</h2>

<p>If you need a MOBI file for Kindle, we recommend putting your EPUB into the <a href="http://www.amazon.com/gp/feature.html?docId=1000765261">Kindle Previewer</a>, which automatically converts to MOBI using Kindlegen and saves the MOBI file to a folder beside your EPUB.</p>

<p>If Previewer cannot convert the EPUB, we’ve found that adding it to <a href="http://calibre-ebook.com/">Calibre</a> first, then (without converting) give Calibre’s version to Kindle Previewer. Calibre gives you greater control over specific ebook conversions, but we’ve found Kindle Previewer converts some CSS better (e.g. floats and borders).</p>

<blockquote class="box">
  <p>If you need to dig into a mobi file’s code to troubleshoot, try the <a href="http://www.mobileread.com/forums/showthread.php?t=171529">KindleUnpack plugin for Calibre</a>.</p>
</blockquote>

<h2 id="adding-ibooks-display-options-file">Adding iBooks display-options file</h2>

<p>If you need to add the <code class="highlighter-rouge">com.apple.ibooks.display-options.xml</code> file to your epub for iBooks display options, you can use the <a href="http://www.mobileread.com/forums/showthread.php?t=272241">AddiBooksXML</a> plugin in Sigil.</p>

<p>A very basic display-options file contains this XML:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;display_options&gt;</span>
    <span class="nt">&lt;platform</span> <span class="na">name=</span><span class="s">"*"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">name=</span><span class="s">"specified-fonts"</span><span class="nt">&gt;</span>true<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">name=</span><span class="s">"interactive"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">name=</span><span class="s">"fixed-layout"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">name=</span><span class="s">"open-to-spread"</span><span class="nt">&gt;</span>false<span class="nt">&lt;/option&gt;</span>
        <span class="nt">&lt;option</span> <span class="na">name=</span><span class="s">"orientation-lock"</span><span class="nt">&gt;</span>none<span class="nt">&lt;/option&gt;</span>
    <span class="nt">&lt;/platform&gt;</span>
<span class="nt">&lt;/display_options&gt;</span>
</code></pre>
</div>

<p>The file should be in the epub’s META-INF folder, which Sigil does not let you edit by default, hence the need for the plugin.</p>

<p>To install the plugin:</p>

<ul>
  <li><a href="http://www.mobileread.com/forums/showthread.php?t=272241">Download the zip file</a>.</li>
  <li>In Sigil, go to Plugins &gt; Manage Plugins.</li>
  <li>Click Add Plugin and locate and select the zip file you downloaded.</li>
</ul>

<p>To use the plugin:</p>

<ul>
  <li>First, in a plain-text/code editor create an <code class="highlighter-rouge">com.apple.ibooks.display-options.xml</code> file containing only the XML shown above. If necessary, change the five options settings in it. Save the XML file with your source material for the book for future use/reference.</li>
  <li>In Sigil, with the epub open, go to Plugins &gt; Edit &gt; AddiBooksXML and find and select the <code class="highlighter-rouge">com.apple.ibooks.display-options.xml</code> file you just created.</li>
</ul>

	</div><!--#wrapper-->
	

	<div id="footer" class="non-printing">
		<div class="footer-content">
			<p>
				<a href="http://electricbookworks.com" title="Electric Book Works" class="footer-publisher">Electric Book Works</a>
				<a href="/electric-book-workflow/" title="Home: Electric Book Workflow" class="footer-series">Electric Book Workflow</a>
				<a href="0-3-contents.html" title="Contents: " class="footer-book"><em>A Guide to the Electric Book Workflow</em></a>
				<a href="" title="Top: Epub output" class="footer-page">Epub output</a>
			</p>
		</div><!--.footer-content-->
	</div><!--#footer-->

	
</body>
</html>



